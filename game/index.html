<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <title>oh tree, oh (s)</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {box-sizing: border-box;}
        body {
            margin: 0;
            
            width: 100vw;
            height: 100vh;
        }
        header {
            width: 100vw;
            font-weight: bold;
            text-align: center;
            line-height: 25vh;
            color: white;
            font-family: Roboto, sans-serif;
            font-size: 3em;
        }
        p {
            text-align: center;
            font-family: Roboto, sans-serif;
            font-size: 1.35em;
            color: white;
        }
        .center {
            text-align: center;
        }
        input[type=text] {
            padding: 1em;
            padding-left: 0;
            text-indent: 1em;
            color: white;
            background: #17567a;
            border: 3px solid #FFF;
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.356);
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.63);
        }
        button {
            margin-top: 0.5em;
            padding: 0.5em;
            color: black;
            border: none;
            background: #ffffff;
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.356);
        }
        .almost-sides {
            max-width: calc(100vw - 25px);
            margin: auto;
        }

        #hud {
            position: fixed;
            font-family: Roboto, sans-serif;
            top: 0;
            right: 0;
            color: white;
            width: 100%;
        }
        #name-in-corner {
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .state {
            display:none;
        }

        #join-url {
            color: black;
            background: white;
            padding: 1.25em 1em;
            box-shadow: 0 2px 4px #00000040;
            width: min-content;
            /* margin: 1.5em auto; */
            user-select: all;

            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #join-url-container:hover #join-url {
            color: #17567a;
            cursor: pointer;

            transform: translateY(-3.5px);
            box-shadow: 0 4px 6px #00000040;
        }
        #join-url-container {
            /* padding: 1.25em 1em; */
            width: min-content;
            margin: 1.5em auto;
        }
        .bg {
            z-index: -1;
            position: fixed;
            top:0;
            left:0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(0deg, #7992ff 0%, #79ceff 100%);
        }
        .player-icon {
            display: block;
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 3px;
            box-shadow: 0 2px 4px #00000040;
            opacity: 0.9;
            margin: auto;
            border: 2px solid black;
        }
        .player-info {
            flex-grow: 1;
        }
        .players {
            flex-direction: row;
            display: flex;
            width: 100%;
            margin: auto;
            margin-bottom: 2em;
        }
        .player-label {
            font-family: Roboto, sans-serif;
            color: white;
            margin-top: 0.75em;
            text-align: center;
        }
        .unjoined .player-label {
            opacity: 0.4;
        }
        .unjoined .player-icon {
            opacity: 0.7;
        }

        .player-info:not(.unjoined) > .red {
            background: rgb(255, 66, 66);
        }
        .player-info:not(.unjoined) > .green {
            background: rgb(66, 255, 113);
        }
        .player-info:not(.unjoined) > .blue {
            background: rgb(66, 69, 255);
        }
        .player-info:not(.unjoined) > .purple {
            background: rgb(186, 66, 255);
        }

        @keyframes enablejs____thanks {
            to {opacity: 1;}
        }
        .enable-your-javascript {
            animation: enablejs____thanks 1s 0.2s;
            animation-fill-mode: forwards;
            opacity: 0;
            display: block;
        }

        footer {
            color: white;
            text-align: center;
            font-family: "Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
            height: 48px;
            line-height: 48px;
            font-size: 16px;
        }
        
        .a-slightly-smaller-font {
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="bg"></div>

    <div id="hud">
        <div style="max-width:500px;margin:auto;position:relative;">
            <div id="name-in-corner"></div>
        </div>
    </div>
    
    <div style="display:flex;flex-direction:column;min-height:100%;">
        <div style="flex-grow: 1;" id="state-surface">
            <header>game</header>
            
            <section class="state enable-your-javascript show:no-js">
                <p>Please Enable JavaScript</p>
            </section>
            
            <section class="state show:name-screen">
                <p>Enter your Name</p>
                <form submit="handleNameEnter">
                    <p>
                        <input type="text" placeholder="Name" autocomplete="false" id="name-input">
                        <button type="submit">Continue</button>
                    </p>
                </form>
            </section>
            
            <section class="state show:too-big">
                <p>Uh Oh!</p>
                <p class="almost-sides a-slightly-smaller-font">That room is already full (4 Players Per Room). You can generate a new room url by clicking the button below.</p>
                <p>
                    <button id="new-room">Join Empty Room</button>
                </p>
            </section>
            
            <section class="state show:disconnected">
                <p>Uh Oh!</p>
                <p class="almost-sides">You got disconnected from your game. Dont close the tab, we will reconnect you
                    automatically.</p>
            </section>
            
            <section class="state show:lobby">
                <p class="almost-sides">Send this URL to a friend, and wait for them to join</p>
            
                <div id="join-url-container">
                    <p id="join-url"></p>
                </div>
            
                <div class="room-details">
                    <p>Waiting for Players</p>
                    <div class="players">
                        <div class="player-info unjoined player1i">
                            <div class="player-icon red"></div>
                            <div class="player-label">(Open)</div>
                        </div>
                        <div class="player-info unjoined player2i">
                            <div class="player-icon green"></div>
                            <div class="player-label">(Open)</div>
                        </div>
                        <div class="player-info unjoined player3i">
                            <div class="player-icon blue"></div>
                            <div class="player-label">(Open)</div>
                        </div>
                        <div class="player-info unjoined player4i">
                            <div class="player-icon purple"></div>
                            <div class="player-label">(Open)</div>
                        </div>
                    </div>
                </div>
                <div id="start-game-section">
                    <p>
                        <button>Start Game</button>
                    </p>
                </div>
            </section>
        </div>
        <a href="https://davecode.me/made-with-love" style="text-decoration:none">
            <footer>Made with <svg height="20px" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" aria-hidden="true" width="18px" style="color: rgb(255, 0, 0); transform: translateY(5px);"><path fill="currentColor" d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"></path></svg> by Humans</footer>
        </a>
    </div>


    <script>
        // basically jquery
        var $ = document.querySelector.bind(document);
        var $$ = (q) => Array.from(document.querySelectorAll(q));
        var $class = (q) => Array.from(document.getElementsByClassName(q));
        var $tagName = (q) => Array.from(document.getElementsByTagName(q));
        var $id = document.getElementById.bind(document);
        EventTarget.prototype.on = EventTarget.prototype.addEventListener;
        EventTarget.prototype.off = EventTarget.prototype.removeEventListener;
        EventTarget.prototype.emit = EventTarget.prototype.dispatchEvent;
        HTMLElement.prototype.hide = function(){this.style.display="none";}
        HTMLElement.prototype.show = function(){this.style.display="initial";}
        HTMLElement.prototype.$ = HTMLElement.prototype.querySelector;
        HTMLElement.prototype.$$ = function(q) { return Array.from(HTMLElement.prototype.querySelector.bind(this)(q)); };
        // end basically jquery

        // form safe
        $$("form[submit]").forEach(item => {
            var func = item.getAttribute("submit");
            item.onsubmit = function() {
                try {
                    window[func]();
                } catch (error) {
                    console.log(error);
                }
                return false;
            };
        })
        // end form safe

        // state magic
        
        var state = "no-js";
        function setState(newstate) {
            $class("show:" + state).forEach(x => x.hide());
            state = newstate;
            $class("show:" + state).forEach(x => x.show());
        }
        
        // end state magic
    </script>

    <script>
        var name = "name not set name not set";
        var socket = io();
        var room = null;
        var players = null;
        var isLeader = false;
        var id = null;
        var our_index = 0;
        var DisconnectedPrevState = null;

        // handles updating all components in the lobby state.
        function updateLobbyUI() {
            // ignore if not initialized.
            if(!players) return;

            // leader controls
            if(isLeader) {
                $("#start-game-section").show();
            } else {
                $("#start-game-section").hide();
            }

            // player information
            for (let index = 0; index < 4; index++) {
                let isInLobby = false;
                let playerName = null;

                // get info
                if(index == our_index) {
                    // us
                    isInLobby = true;
                    playerName = "You";
                } else {
                    // them
                    const player = players[index > our_index ? index - 1: index];
                    
                    isInLobby = !!player;
                    if(isInLobby) {
                        playerName = player.name || "(Player)";
                        playerColor = "green";
                    }
                }

                // render
                const elem = $(".player" + (index + 1) + "i");
                if(isInLobby) {
                    elem.classList.remove("unjoined");
                    elem.$(".player-label").innerHTML = playerName;
                } else {
                    elem.classList.add("unjoined");
                    elem.$(".player-label").innerHTML = "(Open)";
                }
            }
        }

        // when we join/reconnect, we get our own socket code.
        socket.on("socket code", (code) => {
            id = code;
            console.info("Socket ID: ", id);
            
            socket.emit("join room", room);

            if(name !== "name not set name not set") {
                socket.emit("name entry", name);
            }

            // if disconnected, go back to its state.
            if(DisconnectedPrevState) {

                setState(DisconnectedPrevState);
                DisconnectedPrevState = null;

            }
        });
        // current room information, and our index.
        socket.on("join info", (index, list) => {
            our_index = index;
            players = list;
            console.info("Player List: ", list);
            updateLobbyUI();
        });
        // when someone new joins, their name is always placed at the end of the list
        socket.on("player join", (newPlayer) => {
            players.push(newPlayer);
            console.info("Player Joined: ", newPlayer);
            updateLobbyUI();
        });
        // when someone sets their name
        socket.on("player name set", (playerId, playerName) => {

            players.some((x) => {
                if(x.id === playerId) {
                    x.name = playerName;

                    return true;
                }
            });
            console.info("Player Name Set: ", playerId, "=", playerName);

            updateLobbyUI();
        });
        // when someone leaves, also gives updated index
        socket.on("player leave", (playerID, yourNewIndex) => {
            players = players.filter( x => x.id !== playerID);
            our_index = yourNewIndex;

            console.info("Player Left: ", playerID);
            updateLobbyUI();
        });
        // when you recieve leader, also given at room join
        socket.on("youre leader", () => {
            console.info("You are the room Leader.");
            isLeader = true;
            updateLobbyUI();
        });
        // when you are no longer leader; this is probably unused, but maybe
        socket.on("youre not leader", () => {
            isLeader = false;
            updateLobbyUI();
        });
        // disconnnected
        socket.on("disconnect", () => {
            // to big will disconnect us, so ignore
            if(state=="too-big") return;
            
            DisconnectedPrevState = state;
            setState("disconnected");
        });
        // this also disconnects us
        socket.on("room too big", () => {
            setState("too-big");
        })
    
        function makeid() {
            var text = "";
            var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

            for (var i = 0; i < 5; i++)
                text += possible.charAt(Math.floor(Math.random() * possible.length));

            return text;
        }

        // handle the url stuff
        if(!location.href.includes("#")) {
            room = makeid();
            history.replaceState({}, document.title, "/#" + room);
        } else {
            room = location.href.split("#")[1];
            if(/[^a-zA-Z0-9]/.exec(room) !== null) {
                console.warn("Page loaded with an invalid room id, regenerating!");
                console.warn("The charset allowed in room ids is [a-zA-Z0-9]");

                room = makeid();
                history.replaceState({}, document.title, "/#" + room);
            }
        }
        $("#join-url").innerHTML = location.href;
        $("#join-url-container").appendChild($("#join-url"));

        // initial state
        setState('name-screen');

        // logic for name entry
        function handleNameEnter() {
            var elem = $("#name-input");
            name = elem.value;
            
            $("#name-in-corner").innerHTML = name;
            
            setState("lobby");

            socket.emit("name entry", name);
        }

        // logic for the "room is full" state
        $("#new-room").on("click", () => {
            // reload!
            fetch("/empty-room").then(x => x.text()).then(room => {
                location.href = "/#" + room;
                location.reload();
            });
        });

        // focus the name input
        $("#name-input").focus();
        // also focus the name input
        $("#state-surface").on("click", function(ev) {
            if(state === "name-screen" && ev.target.id === "state-surface") {
                $("#name-input").focus();
            }
        });
    </script>
</body>
</html>